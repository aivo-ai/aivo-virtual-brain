apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: analytics-svc-rollout
  namespace: aivo-system
  labels:
    app.kubernetes.io/name: analytics-svc
    app.kubernetes.io/part-of: aivo-platform
    aivo.dev/component: analytics
spec:
  replicas: 2
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app.kubernetes.io/name: analytics-svc
  template:
    metadata:
      labels:
        app.kubernetes.io/name: analytics-svc
        app.kubernetes.io/part-of: aivo-platform
        aivo.dev/component: analytics
        aivo.dev/owner: service
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: analytics-svc
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: analytics-svc
          image: aivo/analytics-svc:v1.0.0
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
            - containerPort: 8081
              name: grpc
              protocol: TCP
          env:
            - name: PORT
              value: "8080"
            - name: GRPC_PORT
              value: "8081"
            - name: LOG_LEVEL
              value: "info"
            - name: PROMETHEUS_ENABLED
              value: "true"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10001
            seccompProfile:
              type: RuntimeDefault
          resources:
            requests:
              memory: 256Mi
              cpu: 100m
            limits:
              memory: 1Gi
              cpu: 1000m
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
  strategy:
    blueGreen:
      activeService: analytics-svc-active
      previewService: analytics-svc-preview
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 300 # 5 minutes
      prePromotionAnalysis:
        templates:
          - templateName: comprehensive-slo
        args:
          - name: service-name
            value: analytics-svc
          - name: namespace
            value: aivo-system
      postPromotionAnalysis:
        templates:
          - templateName: success-rate-slo
          - templateName: latency-p95-slo
        args:
          - name: service-name
            value: analytics-svc
          - name: namespace
            value: aivo-system
          - name: success-threshold
            value: "99.0"
          - name: latency-threshold
            value: "500"
      activeMetadata:
        labels:
          role: active
      previewMetadata:
        labels:
          role: preview
---
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: notification-svc-rollout
  namespace: aivo-system
  labels:
    app.kubernetes.io/name: notification-svc
    app.kubernetes.io/part-of: aivo-platform
    aivo.dev/component: notifications
spec:
  replicas: 2
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app.kubernetes.io/name: notification-svc
  template:
    metadata:
      labels:
        app.kubernetes.io/name: notification-svc
        app.kubernetes.io/part-of: aivo-platform
        aivo.dev/component: notifications
        aivo.dev/owner: service
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: notification-svc
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: notification-svc
          image: aivo/notification-svc:v1.0.0
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
            - containerPort: 8081
              name: grpc
              protocol: TCP
          env:
            - name: PORT
              value: "8080"
            - name: GRPC_PORT
              value: "8081"
            - name: LOG_LEVEL
              value: "info"
            - name: PROMETHEUS_ENABLED
              value: "true"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10001
            seccompProfile:
              type: RuntimeDefault
          resources:
            requests:
              memory: 256Mi
              cpu: 100m
            limits:
              memory: 1Gi
              cpu: 1000m
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
  strategy:
    blueGreen:
      activeService: notification-svc-active
      previewService: notification-svc-preview
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 300
      prePromotionAnalysis:
        templates:
          - templateName: comprehensive-slo
        args:
          - name: service-name
            value: notification-svc
          - name: namespace
            value: aivo-system
      postPromotionAnalysis:
        templates:
          - templateName: success-rate-slo
          - templateName: latency-p95-slo
        args:
          - name: service-name
            value: notification-svc
          - name: namespace
            value: aivo-system
          - name: success-threshold
            value: "99.5"
          - name: latency-threshold
            value: "300"
      activeMetadata:
        labels:
          role: active
      previewMetadata:
        labels:
          role: preview
